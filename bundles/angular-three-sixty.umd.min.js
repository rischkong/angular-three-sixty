!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("@angular/core")):"function"==typeof define&&define.amd?define("angular-three-sixty",["exports","@angular/core"],factory):factory((global.ng=global.ng||{},global.ng.angularThreeSixty={}),global.ng.core)}(this,function(exports,core){"use strict";var ImageLoader=function(){function ImageLoader(){this.cache={}}return ImageLoader.prototype.load=function(url){var _this=this;return new Promise(function(resolve){if(_this.cache.hasOwnProperty(url))return resolve(_this.cache[url]);var image=new Image;image.onload=function(){_this.cache[url]=image,resolve(image)},image.src=url})},ImageLoader}(),Hammer=require("hammerjs"),ThreeSixty=function(){function ThreeSixty(canvasElement,configuration){var _this=this;this.canvasElement=canvasElement,this.configuration=configuration,this.hotspotElements=[],this.angle=0,this.preDragAngle=0,this.canvas2dContext=this.canvasElement.getContext("2d"),this.imageLoader=new ImageLoader,window.onresize=function(){return _this.images=_this.getActiveImages()}}return ThreeSixty.prototype.initialize=function(imageSet,startAngle){console.log("iamgeSet",imageSet);var _this=this;if(void 0===startAngle&&(startAngle=0),startAngle<0||startAngle>360)throw new Error("The specified start angle must be between 0 and 360.");this.angle=startAngle,this.imageSet=imageSet,this.images=this.getActiveImages(),this.containerElement=document.createElement("div"),this.containerElement.classList.add(ThreeSixty.CONTAINER_CLASS),this.canvasElement.parentElement.insertBefore(this.containerElement,this.canvasElement),this.containerElement.appendChild(this.canvasElement),this.initializeHotspots(),this.initializeEventListeners();var imageIndexes=this.getImageIndexesForCurrentAngle();this.imageLoader.load(this.images[imageIndexes.targetSpriteIndex]).then(function(image){return _this.drawAngle(image,imageIndexes.targetImageIndex)})},ThreeSixty.prototype.updateConfiguration=function(configuration){this.configuration=configuration,this.hotspotElements.forEach(function(hotspotElement){return hotspotElement.parentElement.removeChild(hotspotElement)}),this.hotspotElements=[],this.initializeHotspots()},ThreeSixty.prototype.updateImages=function(imageSet){var _this=this;this.imageSet=imageSet,this.images=this.getActiveImages();var imageIndexes=this.getImageIndexesForCurrentAngle();this.imageLoader.load(this.images[imageIndexes.targetSpriteIndex]).then(function(image){return _this.drawAngle(image,imageIndexes.targetImageIndex)})},ThreeSixty.prototype.preload=function(){var _this=this;return new Promise(function(resolve){var imagesLoaded=0;_this.images.forEach(function(url){_this.imageLoader.load(url).then(function(){++imagesLoaded===_this.images.length&&resolve()})}.bind(_this))})},ThreeSixty.prototype.getActiveImages=function(){var width=window.outerWidth,activeBreakpoint=Object.keys(this.imageSet).sort().reverse().find(function(breakpoint){if(parseFloat(breakpoint)<=width)return!0});return this.imageSet[activeBreakpoint]},ThreeSixty.prototype.initializeHotspots=function(){var _this=this;this.configuration.hotspots&&(this.configuration.hotspots.forEach(function(hotspot){var hotspotElement=document.createElement("div");hotspotElement.classList.add(ThreeSixty.HOTSPOT_CLASS),hotspotElement.innerText=hotspot.text,hotspot.top&&(hotspotElement.style.top=hotspot.top),hotspot.left&&(hotspotElement.style.left=hotspot.left),_this.hotspotElements.push(hotspotElement)}),this.hotspotElements.forEach(function(hotSpotElement){return _this.containerElement.appendChild(hotSpotElement)}),this.showActiveHotspots())},ThreeSixty.prototype.showActiveHotspots=function(){var _this=this;this.configuration.hotspots&&this.configuration.hotspots.forEach(function(hotspot,i){hotspot.angle<=_this.angle&&hotspot.endAngle>=_this.angle?_this.hotspotElements[i].classList.add(ThreeSixty.HOTSPOT_ACTIVE_CLASS):_this.hotspotElements[i].classList.remove(ThreeSixty.HOTSPOT_ACTIVE_CLASS)})},ThreeSixty.prototype.initializeEventListeners=function(){this.hammer=new Hammer(this.canvasElement),this.hammer.get("pan").set({direction:Hammer.DIRECTION_HORIZONTAL,threshold:0}),this.hammer.on("pan",this.onDrag.bind(this)),this.hammer.on("panstart",this.onDragStart.bind(this))},ThreeSixty.prototype.getImageIndexesForCurrentAngle=function(){var targetImageIndex=Math.round(this.angle/(360/this.configuration.angles)),targetSpriteIndex=Math.floor(targetImageIndex/this.configuration.anglesPerImage);return{targetImageIndex:targetImageIndex%this.configuration.anglesPerImage,targetSpriteIndex:targetSpriteIndex}},ThreeSixty.prototype.drawAngle=function(image,imageIndex){var _this=this,loaded=!1,_drawAngle=function(){_this.canvas2dContext.drawImage(image,0,-_this.canvasElement.height*imageIndex,_this.canvasElement.width,_this.canvasElement.height*_this.configuration.anglesPerImage),loaded||(window.requestAnimationFrame(_drawAngle.bind(_this)),loaded=!0)};window.requestAnimationFrame(_drawAngle.bind(this))},ThreeSixty.prototype.onDrag=function(e){var _this=this;this.adaptAngle(-e.deltaX);var imageIndexes=this.getImageIndexesForCurrentAngle();this.imageLoader.load(this.images[imageIndexes.targetSpriteIndex]).then(function(image){return _this.drawAngle(image,imageIndexes.targetImageIndex)}),this.showActiveHotspots()},ThreeSixty.prototype.onDragStart=function(){this.preDragAngle=this.angle},ThreeSixty.prototype.adaptAngle=function(distance){for(var dx=(distance=Math.ceil(distance*(this.configuration.speedFactor?this.configuration.speedFactor:5)))/window.innerWidth,tmpAngle=1-this.preDragAngle/360+1.5*dx;tmpAngle<0;)tmpAngle++;tmpAngle%=1,this.angle=-360*tmpAngle+360},ThreeSixty.CONTAINER_CLASS="three-sixty-container",ThreeSixty.HOTSPOT_CLASS="three-sixty__hotspot",ThreeSixty.HOTSPOT_ACTIVE_CLASS="three-sixty__hotspot--active",ThreeSixty}(),ThreeSixtyFactory=function(){function ThreeSixtyFactory(){}return ThreeSixtyFactory.prototype.create=function(canvasElement,configuration){return new ThreeSixty(canvasElement,configuration)},ThreeSixtyFactory}(),ThreeSixtyComponent=function(){function ThreeSixtyComponent(threeSixtyFactory){this.threeSixtyFactory=threeSixtyFactory,this.startAngle=0,this.images={},this.preload=!1,this.preloaded=new core.EventEmitter}return ThreeSixtyComponent.prototype.ngOnInit=function(){this.threeSixty=this.threeSixtyFactory.create(this.canvasElement.nativeElement,this.getThreeSixtyConfiguration()),this.threeSixty.initialize(this.images,this.startAngle),this.preloadImages()},ThreeSixtyComponent.prototype.ngOnChanges=function(changes){this.threeSixty&&((Object.keys(changes).length>1||!changes.hasOwnProperty("images"))&&this.threeSixty.updateConfiguration(this.getThreeSixtyConfiguration()),changes.hasOwnProperty("images")&&(this.threeSixty.updateImages(this.images),this.preloadImages()))},ThreeSixtyComponent.prototype.forcePreload=function(){var _this=this;this.threeSixty.preload().then(function(){return _this.preloaded.emit()})},ThreeSixtyComponent.prototype.preloadImages=function(){var _this=this;this.preload&&this.threeSixty.preload().then(function(){return _this.preloaded.emit()})},ThreeSixtyComponent.prototype.getThreeSixtyConfiguration=function(){var configuration={angles:this.angles,anglesPerImage:this.anglesPerImage};return this.speedFactor>=0&&(configuration.speedFactor=this.speedFactor),this.hotspots&&(configuration.hotspots=this.hotspots),configuration},ThreeSixtyComponent.decorators=[{type:core.Component,args:[{selector:"mm-three-sixty",styles:[".three-sixty-container{position:relative;cursor:move;cursor:-webkit-grab;-ms-touch-action:none;touch-action:none}.three-sixty__hotspot{display:none;position:absolute;width:200px;padding:10px 15px;background:rgba(0,0,0,.5);border-radius:20px;color:#fff}.three-sixty__hotspot--active{display:block}"],template:'<canvas #canvasElement class="mm-three-sixty" [width]="width" [height]="height"></canvas>',encapsulation:core.ViewEncapsulation.None}]}],ThreeSixtyComponent.ctorParameters=function(){return[{type:ThreeSixtyFactory}]},ThreeSixtyComponent.propDecorators={width:[{type:core.Input}],height:[{type:core.Input}],angles:[{type:core.Input}],anglesPerImage:[{type:core.Input}],startAngle:[{type:core.Input}],images:[{type:core.Input}],speedFactor:[{type:core.Input}],hotspots:[{type:core.Input}],preload:[{type:core.Input}],preloaded:[{type:core.Output}],canvasElement:[{type:core.ViewChild,args:["canvasElement"]}]},ThreeSixtyComponent}(),ThreeSixtyModule=function(){function ThreeSixtyModule(){}return ThreeSixtyModule.decorators=[{type:core.NgModule,args:[{declarations:[ThreeSixtyComponent],providers:[ThreeSixtyFactory],exports:[ThreeSixtyComponent]}]}],ThreeSixtyModule.ctorParameters=function(){return[]},ThreeSixtyModule}();exports.ThreeSixtyModule=ThreeSixtyModule,exports.ThreeSixtyComponent=ThreeSixtyComponent,exports.Éµa=ThreeSixtyFactory,Object.defineProperty(exports,"__esModule",{value:!0})});